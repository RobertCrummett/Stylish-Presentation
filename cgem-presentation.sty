%% CGEM Presentation Package
\ProvidesPackage{cgem-presentation}

%----------------------------------------
%% CGEM Presentation Package Dependencies
% Preamble
\usepackage{amsmath, amsfonts, amssymb} % Math
\usepackage[backend=biber, style=alphabetic]{biblatex} % Bibliogrpahy
\usepackage{fontspec} % Fonts --- If this fails to compile, use XeLaTeX or LuaTeX
\usepackage{graphicx} % Figures
\usepackage{hyperref} % Links
\usepackage{luacode}
\usepackage[absolute,overlay]{textpos} % Figure placement
\usepackage{xcolor} % Colors

% Linking important files and folders
\graphicspath{{./Figure}} % Directory containing all figures

%-----------------------------------------
%% CGEM Settings
\hypersetup{
  colorlinks=true,
  citecolor=cgemblue,
  linkcolor=cgemblue,
  urlcolor=magenta,
} % Link to corresponding author
\definecolor{cgemblue}{HTML}{90C5FB} % CGEM light blue
\setsansfont{Arial}

% Background color
\setbeamercolor{background canvas}{bg = black}
\setbeamercolor{normal text}{fg = white}\usebeamercolor*{normal text}

% Turn off Beamer navigation buttons
\setbeamertemplate{navigation symbols}{}

% Page numbering
\setbeamertemplate{footline}
{
  \hspace{0.97\pagewidth}
  \textcolor{cgemblue}{\large \insertframenumber}
  \vspace{2mm}
}

%------------------------------------------
%% Title page

% Title, Rename to something informative but not too long
\renewcommand{\title}
{
  {\Huge Don't Read Title to Your Audience}
}
% Slide authors. The corresponding author can be indicated with * and hyperlinked 
\renewcommand{\author}
{
  \textcolor{cgemblue}
  {\huge
    R. Nate Crummett\hyperlink{corr}{*} \\ [3mm]
    Author \#2
  }
}
% CGEM Affiliation line
\newcommand{\affilCGEM}
{
  \textit{\color{cgemblue}
  {\Large
    Center for Gravity, Electrical \& Magnetic Studies (CGEM)
  }}
}
% CSM, Department of Geophysics affiliation line
\newcommand{\affilCSM}
{
  \textit{\textcolor{cgemblue}
  {\large
    Department of Geophysics --- Colorado School of Mines
  }}
}
% Meeting affiliations, location, conference name
\newcommand{\affilMeeting}
{
  \textit{Conference/Meeting Name/Location} 
}
% Session information for the specific meeting
\newcommand{\affilInfo}
{
  \textit{Session Information (if available)}
}
% Date / Time of presentation --- make sure to adjust this to the day you will give the presentation!
\renewcommand{\date}
{
  \textit{\today}
}

%% Create formatted title frame with above functions
\newcommand{\titleframe}
{
  \begin{frame}[plain]
    % Mines logo
    \begin{figure}
      \begin{textblock*}{2.05cm}(0.065\paperwidth,0.38\paperheight)
        \includegraphics[width=2.05cm]{mines-2018}
      \end{textblock*}
    \end{figure}
    % CGEM logo
    \begin{figure}
      \begin{textblock*}{2.85cm}(0.77\paperwidth,0.35\paperheight)
        \includegraphics[width=2.85cm]{cgem-logo}
      \end{textblock*}
    \end{figure}
    % Title
    \begin{center}
      \title \\
      \vspace{1cm}
      \author \\ [1.2cm]
      \affilCGEM \\
      \affilCSM \\ [2mm]
      \affilMeeting \\ [-1mm]
      \affilInfo \\ [-1mm]
      \date \vspace{-5mm}
    \end{center}
  \end{frame}
}

%------------------------------------------
%% Enumeration / Itemize  / List Settings, ie, Bullet Point Lists

% Base level
\setbeamertemplate{enumerate item}{\LARGE \color{cgemblue} \textbullet}
\setbeamerfont*{itemize/enumerate body}{size=\LARGE}
\setbeamercolor{itemize/enumerate body}{fg=cgemblue}

% First Level
\setbeamertemplate{enumerate subitem}{\Large \color{white} --}
\setbeamerfont*{itemize/enumerate subbody}{size=\Large}
\setbeamercolor{itemize/enumerate subbody}{fg=white}

% Second Level -- only use in emergencies
\setbeamertemplate{enumerate subsubitem}{\large \color{cgemblue} \textbullet}
\setbeamerfont*{itemize/enumerate subsubbody}{size=\large}
\setbeamercolor{itemize/enumerate subsubbody}{fg=cgemblue}

%------------------------------------------
%% Frame title format

% Frame title
\setbeamertemplate{frametitle}[default][center]
\setbeamerfont*{frametitle}{size=\Huge}
\setbeamercolor{frametitle}{fg=white}

%------------------------------------------
%% Question Slide

\newcommand{\whitebar}
{
  \color{white} \noindent \makebox[\linewidth]{\rule{\textwidth}{0.7pt}}
}
\newcommand{\questionslide}
{
  \begin{frame}[plain]
    \begin{center}
      % Mines logo
      \begin{figure}
        \begin{textblock*}{1cm}(0.065\paperwidth,0.03\paperheight)
          \includegraphics[width=1cm]{mines-2018}
        \end{textblock*}
      \end{figure}
      % CGEM logo
      \begin{figure}
        \begin{textblock*}{1cm}(0.87\paperwidth,0.02\paperheight)
          \includegraphics[width=1.3cm]{cgem-logo}
        \end{textblock*}
      \end{figure}
      % Questions slide
      \color{cgemblue}
      \footnotesize
      \vspace{-8mm}
      Colorado School of Mines \\[2mm]
      \Large
      Center for Gravity, Electrical \& Magnetic Studies \\[-2mm]
      \whitebar \\[1.7cm]
      \color{cgemblue}
      \LARGE
      Thank You \\
      Questions? \\[1.82cm]
      \whitebar \\
      \color{cgemblue}
      \small
      R. Nate Crummett*: \hypertarget{corr}{\href{mailto:robert_crummett@mines.edu}{robert\_crummett@mines.edu}} \\
      Author \#2
    \end{center}
  \end{frame}
}

%-------------------------------------------
%% Bibliography Style

% Lua function to collect *.bib files in Bib directory
% Wonderful idea by Skuost, Dec 5 2023
% https://tex.stackexchange.com/questions/192917/include-all-bib-files-in-one-directory-to-a-bibliography
\begin{luacode*}
  function findBibFiles(folder)
    local files = {}
    local lfs = require("lfs")
    if isDir(folder) then
      for file in lfs.dir(folder) do
        if file:match("%.bib$") then
          table.insert(files, folder .. "/" .. file)
        end
      end
    end
    return files
  end

  function isDir(name)
    if type(name)~="string" then return false end
    local cd = lfs.currentdir()
    local is = lfs.chdir(name) and true or false
    lfs.chdir(cd)
    return is
  end
\end{luacode*}

% Tex function to assemble bibliography
\newcommand{\setbibliographypath}[1]{
  \directlua{
    local files = findBibFiles("#1")
    for _, file in ipairs(files) do
      tex.print("\\addbibresource{" .. file .. "}")
    end
  }
}

% Biblography directory
\setbibliographypath{Bib}

% Biblography colors
\setbeamercolor*{bibliography entry title}{fg=white}
\setbeamercolor*{bibliography entry location}{fg=white}
\setbeamercolor*{bibliography entry note}{fg=white}
\setbeamercolor*{bibliography entry author}{fg=white}
\setbeamercolor*{bibliography item}{fg=cgemblue}

\setbeamertemplate{frametitle continuation}{}

% References slide, usuing everything above to assemble
\newcommand{\references}
{
  \begin{frame}[allowframebreaks, plain]{References}
    \printbibliography
  \end{frame}
}

%--------------------------------------------
%% Citaions

% Figure citation
\newcommand{\citefig}[1]
{
  \begin{flushright}
    \vspace{-4mm}
    \cite{#1}
  \end{flushright}
}
